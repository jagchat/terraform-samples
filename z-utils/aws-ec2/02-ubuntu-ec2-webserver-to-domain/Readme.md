# Quick Notes

# Create Ubuntu EC2 web server and setup hosted zone (existing domain)

This terraform sample demonstrates following:

- Create Ubuntu EC2 with necessary security groups and policies
- Install Apache Web Server on EC2
- Confiure Ubuntu EC2 firewall to allow Apache, 80, 443, 22 ports to connect
- Configure an existing Route53 hosted zone to point to Ubuntu EC2 Web Server
- Configures for http (and not https/SSL)

Pre-requisites:

- Need to have a registered domain (ex: abc.com through godaddy)
- Create a Route53 hosted zone with above domain (which will provide name servers)
- Ensure same name servers are configured for above domain (DNS routing) through domain provider (ex: godaddy)
- It might take 24 hours to reflect changes. Ensure DNS Lookup for the domain shows name servers as expected.
- Please specify VPC id in main.tf to configure security groups for EC2

NOTE:

- `ec2-startup-script.sh` is the file which gets executed within EC2 instance once it is up and running
- It takes few minutes to have EC2 instance up and running and further executes a startup script to install/configure necessary services (ex: Apache, Firewall etc.).
- SSH Key is auto generated by terraform script and will be available as `ubuntu-test-server-key.pem` file in the project folder

## Usage

- Provide `access-key`, `secret-key` and `token` (for MFA) as needed in `main.tf`

  - If AWS configuration is available as part of `.aws/config`, we can use following command (linux):

  ```bash
  export AWS_PROFILE=<your-profile-name>
  ```

- Ensure correct VPC id in main.tf to configure security groups for EC2
- Initialize terraform in the script folder. This step is needed only once to download respective provider to local folder

```bash
terraform init
```

- Following command runs/executes the script and changes get applied to AWS environment. This will also create "state" files (terraform.tfstate.\*)locally to maintain current state of deployment and to help future deployments after modifications to scripts.

```bash
> terraform apply
```

- Please allow 10 to 20 minutes to let EC2 and all its services up and running
- Point browser to your domain (ex: http://www.abc.com) and it should show default Apache Web Page

- Following command permanently deletes the deployment (including state)

```bash
terraform destroy
```

## Troubleshooting

- In order to connect to EC2 server remotely from local machine, we use SSH. SSH Key is auto generated by terraform script and will be available as `ubuntu-test-server-key.pem` file in the project folder.
- Change the permissions of the file in project folder:

```bash
chmod 600 ./ubuntu-test-server-key.pem
```

- Using AWS Console, get the Public IPv4 DNS of the EC2 (ex: ec2-18-215-236-214.compute-1.amazonaws.com)
- Use following command to connect to EC2 instance remotely (default user name for the AMI we used is `ubuntu`)

```bash
ssh -i "ubuntu-test-server-key.pem" ubuntu@ec2-18-215-236-214.compute-1.amazonaws.com
```

- Once connected, we can check the status of Apache webserver using the following command:

```bash
sudo systemctl status apache2
```

- Also, logs of our startup script are preserved in `/var/log/user-data.log` file in EC2
